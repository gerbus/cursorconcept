<!DOCTYPE html>
<html>

<head>
  <title>Self is an illustion</title>
  <style>
    body {
      margin: 0;
      padding-bottom: 3rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #888
    }

    #canvas {
      margin: 10vh 10vw;
      width: 80vw;
      height: 80vh;
      background: black;
      position: relative;
    }

    .cursor {
      position: absolute;
    }
  </style>
</head>

<body>
  <svg id="cursor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
    width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
    <polygon fill="#FF0000" points="8.2,20.9 8.2,4.9 19.8,16.5 13,16.5 12.6,16.6 " />
    <polygon fill="#FF0000" points="17.3,21.6 13.7,23.1 9,12 12.7,10.5 " />
    <rect x="12.5" y="13.6" transform="matrix(0.9221 -0.3871 0.3871 0.9221 -5.7605 6.5909)" width="2" height="8" />
    <polygon points="9.2,7.3 9.2,18.5 12.2,15.6 12.6,15.5 17.4,15.5 " />
  </svg>
  <div id="canvas">
    <div id="my_cursor" class="cursor">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="28px"
        height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
        <polygon fill="#00FF00" points="8.2,20.9 8.2,4.9 19.8,16.5 13,16.5 12.6,16.6 " />
        <polygon fill="#00FF00" points="17.3,21.6 13.7,23.1 9,12 12.7,10.5 " />
        <rect x="12.5" y="13.6" transform="matrix(0.9221 -0.3871 0.3871 0.9221 -5.7605 6.5909)" width="2" height="8" />
        <polygon points="9.2,7.3 9.2,18.5 12.2,15.6 12.6,15.5 17.4,15.5 " />
      </svg>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const pointerIds = [];
    const socket = io();
    const canvas = document.getElementById('canvas');
    const canvasCoords = canvas.getBoundingClientRect();
    const cursor = document.getElementById('cursor')

    const updateCursor = (id, x, y) => {
      const cursor = document.getElementById(id);
      cursor.style.left = x + 'px';
      cursor.style.top = y + 'px';
    }

    // My cursor (local shadow)
    canvas.addEventListener('pointermove', (event) => {
      event.preventDefault();
      const coords = {
        x: parseInt(event.clientX - canvasCoords.left - 8),
        y: parseInt(event.clientY - canvasCoords.top - 7)
      }

      // send to others
      socket.emit('pointer', coords)

      // update local shadow
      updateCursor('my_cursor', coords.x, coords.y)
    })

    // Other peoples' cursors
    const addPointer = id => {
      pointerIds.push(id);

      const newCursorDiv = document.createElement('div');
      const newCursor = cursor.cloneNode(true);
      newCursor.removeAttribute('id');
      newCursorDiv.appendChild(newCursor);
      newCursorDiv.setAttribute('id', id);
      newCursorDiv.setAttribute('class', 'cursor')
      canvas.appendChild(newCursorDiv);
    }
    const removePointer = id => {
      const index = pointerIds.indexOf(id);
      if (index > -1) pointerIds.splice(index, 1);

      const cursor = document.getElementById(id);
      cursor.remove();
    }
    socket.on('pointer', ({ coords, id }) => {
      console.log(`received from ${id}`)
      const pointerIsNew = !pointerIds.includes(id);
      if (pointerIsNew) {
        addPointer(id);
        console.log(`\tnew pointer`);
      } else {
        console.log(`\tpointer moved`);
        updateCursor(id, coords.x, coords.y);
      }
    })
    socket.on('dead pointer', id => {
      console.log(`dead pointer ${id}`);
      removePointer(id);
    })
  </script>
</body>

</html>
